<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SciBox Interview - Собеседование</title>
    <script src="https://www.google.com/recaptcha/api.js?render=6LeNDRksAAAAAFpfLym3unGOmDpGMqTZybb_6QA1"></script>
    <link rel="stylesheet" href="../static/css/styles.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">SciBox Interview</div>
            <div class="header-controls">
                <div class="progress-container">
                    <div class="progress-info">
                        <span>Прогресс: </span>
                        <span id="progressText">0/? задач</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    <div class="timer" id="timer">45:00</div>
                </div>
                <button class="btn btn-danger" onclick="endInterview()">Завершить</button>
            </div>
        </header>

        <div class="interview-container">
            <!-- Левая панель - Задача -->
            <div class="problem-panel">
                <div class="panel-tabs">
                    <div class="tab active" data-tab="task">Задача</div>
                    <div class="tab" data-tab="examples">Примеры</div>
                </div>
                <div class="panel-content">
                    <!-- Вкладка "Задача" -->
                    <div class="tab-content active" id="task-tab">
                        <div class="problem-content">
                            {% if error %}
                                <div class="error-message" style="color: #EF4444; padding: 20px; background: #FEE2E2; border-radius: 8px; margin-bottom: 20px;">
                                    <h3>Ошибка загрузки задачи</h3>
                                    <p>{{ error }}</p>
                                </div>
                            {% elif task %}
                                <h3>{{ task.get('title', task.get('id', 'Задача')) }}</h3>
                                <div class="task-description">
                                    <p style="white-space: pre-wrap;">{{ task.get('description', 'Описание задачи отсутствует') }}</p>
                                </div>
                                {% if task.get('constraints') %}
                                    <div class="task-constraints" style="margin-top: 15px; padding: 10px; background: #F3F4F6; border-radius: 6px;">
                                        <strong>Ограничения:</strong>
                                        <p style="white-space: pre-wrap;">{{ task.get('constraints') }}</p>
                                    </div>
                                {% endif %}
                            {% else %}
                                <h3>Загрузка задачи...</h3>
                                <p>Пожалуйста, подождите, задача генерируется...</p>
                            {% endif %}
                        </div>
                        {% if task and task.get('id') %}
                            <button class="btn btn-primary run-tests-btn" data-task-id="{{ task.get('id') }}" onclick="runTests()">
                                Запустить тесты
                            </button>
                        {% else %}
                            <button class="btn btn-primary run-tests-btn" data-task-id="" onclick="runTests()" disabled>
                                Запустить тесты
                            </button>
                        {% endif %}
                    </div>
                    
                    <!-- Вкладка "Примеры" -->
                    <div class="tab-content" id="examples-tab" style="display: none;">
                        <div class="problem-content">
                            {% if task and task.get('test_cases') %}
                                <h4>Все примеры ввода/вывода:</h4>
                                {% for test_case in task.get('test_cases', []) %}
                                    <div style="margin-bottom: 20px; padding: 15px; background: #1F2937; color: #F9FAFB; border-radius: 6px; font-family: monospace;">
                                        <div style="margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #374151;">
                                            <strong style="color: #9CA3AF;">Пример {{ loop.index }}:</strong>
                                        </div>
                                        <div style="margin-bottom: 8px;">
                                            <strong style="color: #60A5FA;">Ввод:</strong>
                                            <pre style="margin: 5px 0; white-space: pre-wrap; background: #111827; padding: 8px; border-radius: 4px;">{{ test_case.get('input', '') }}</pre>
                                        </div>
                                        <div>
                                            <strong style="color: #34D399;">Вывод:</strong>
                                            <pre style="margin: 5px 0; white-space: pre-wrap; background: #111827; padding: 8px; border-radius: 4px;">{{ test_case.get('output', '') }}</pre>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% elif task %}
                                <p>Примеры тестовых случаев отсутствуют</p>
                            {% else %}
                                <p>Задача не загружена</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Центральная панель - Редактор -->
            <div class="editor-panel">
                <div class="editor-header">
                    <!-- Кастомный dropdown -->
        <div class="custom-dropdown" id="languageDropdown">
            <div class="dropdown-selected" id="dropdownSelected">
                <span class="selected-text">Python</span>
                <div class="dropdown-arrow"></div>
            </div>
            <div class="dropdown-options">
                <div class="dropdown-option" data-value="python">Python</div>
                <div class="dropdown-option" data-value="javascript">JavaScript</div>
                <div class="dropdown-option" data-value="java">Java</div>
                <div class="dropdown-option" data-value="cpp">C++</div>
            </div>
        </div>
                </div>
                <div class="editor-area">
                    <textarea class="code-editor" placeholder="// Напишите ваш код здесь...">
// Пример кода
function solution() {
    return true;
}
                    </textarea>
                </div>
                <div class="console-panel">
                    <div class="console-content" id="consoleOutput">> Результаты тестов появятся здесь...</div>
                </div>
            </div>

            <!-- Правая панель - Чат -->
            <div class="chat-panel">
                <div class="chat-header">
                    AI Интервьюер
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="message message-ai">
                        Здравствуйте! Я ваш AI-интервьюер. Начнем собеседование...
                    </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" placeholder="Введите ваше сообщение...">
                    <button class="btn btn-primary send-btn" onclick="sendMessage()">Отправить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно окончания времени -->
    <div id="timeUpModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-icon">⏰</div>
            <h2>Время вышло!</h2>
            <p>Собеседование завершено. Ваши результаты сохраняются...</p>
            <div class="modal-progress">
                <div class="modal-progress-bar">
                    <div class="modal-progress-fill"></div>
                </div>
                <span class="modal-countdown">Перенаправление через: <span id="redirectCountdown">5</span>с</span>
            </div>
            <button class="btn btn-primary" onclick="redirectNow()">Перейти к результатам</button>
        </div>
    </div>

    <script>
        // Переменные для управления
        let timerInterval;
        let totalTime = 45 * 60; // 45 минут в секундах
        let timeLeft = totalTime;
        
        // Прогресс по задачам
        let totalTasks = 4; // Всего задач в собеседовании
        let completedTasks = 0; // Решенные задачи
        let currentTaskProgress = 0; // Прогресс текущей задачи (0-100%)

        // Запуск при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
            startTimer();
            updateProgressBar();
            
            // Сохраняем task_id в глобальную переменную для использования в runTests()
            const runTestsBtn = document.querySelector('.run-tests-btn');
            if (runTestsBtn && runTestsBtn.dataset.taskId) {
                window.currentTaskId = runTestsBtn.dataset.taskId;
            }
            
            // Обработка переключения вкладок
            const tabs = document.querySelectorAll('.panel-tabs .tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    // Убираем активный класс со всех вкладок
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Скрываем все содержимое вкладок
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.style.display = 'none';
                        content.classList.remove('active');
                    });
                    
                    // Показываем выбранную вкладку
                    const targetTab = document.getElementById(tabName + '-tab');
                    if (targetTab) {
                        targetTab.style.display = 'block';
                        targetTab.classList.add('active');
                    }
                });
            });
        });

        // Функции таймера
        function startTimer() {
            updateTimerDisplay();
            
            timerInterval = setInterval(function() {
                timeLeft--;
                updateTimerDisplay();
                
                // Изменение цвета при малом времени
                const timerElement = document.getElementById('timer');
                if (timeLeft <= 300) { // 5 минут
                    timerElement.style.color = '#EF4444';
                    if (timeLeft <= 60) {
                        timerElement.style.animation = 'pulse 1s infinite';
                    }
                }
                
                // Проверка окончания времени
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    showTimeUpModal();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Функции прогресса задач
        function updateProgressBar() {
            // Общий прогресс = завершенные задачи + прогресс текущей задачи
            const overallProgress = (completedTasks / totalTasks) * 100 + 
                                  (currentTaskProgress / totalTasks);
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            progressFill.style.width = Math.min(overallProgress, 100) + '%';
            progressText.textContent = `${completedTasks}/${totalTasks} задач`;
            
            // Меняем цвет прогресс-бара в зависимости от прогресса
            if (overallProgress >= 75) {
                progressFill.style.background = 'linear-gradient(90deg, #00E5A8, #00AAE5)';
            } else if (overallProgress >= 50) {
                progressFill.style.background = 'linear-gradient(90deg, #F59E0B, #00AAE5)';
            } else {
                progressFill.style.background = 'linear-gradient(90deg, #00AAE5, #0090C5)';
            }
        }

        function completeTask() {
            completedTasks++;
            currentTaskProgress = 0;
            updateProgressBar();
            
            // Уведомление в чат
            addMessage(`Задача ${completedTasks} завершена! Переходим к следующей...`, 'ai');
            
            // Если все задачи решены
            if (completedTasks >= totalTasks) {
                setTimeout(() => {
                    addMessage('Поздравляю! Вы решили все задачи собеседования.', 'ai');
                    setTimeout(() => {
                        endInterviewSuccess();
                    }, 2000);
                }, 1000);
            }
        }

        function updateTaskProgress(progress) {
            currentTaskProgress = progress;
            updateProgressBar();
        }

        function endInterviewSuccess() {
            clearInterval(timerInterval);
            alert('Все задачи решены! Переходим к результатам...');
            window.location.href = 'results';
        }

        // Модальное окно
        function showTimeUpModal() {
            const modal = document.getElementById('timeUpModal');
            modal.style.display = 'flex';
            
            let countdown = 5;
            const countdownElement = document.getElementById('redirectCountdown');
            
            const countdownInterval = setInterval(() => {
                countdownElement.textContent = countdown;
                if (countdown-- <= 0) {
                    clearInterval(countdownInterval);
                    redirectToResults();
                }
            }, 1000);
        }

        function redirectNow() {
            redirectToResults();
        }

        function redirectToResults() {
            window.location.href = 'results';
        }

        // Остальные функции...
        function sendMessage() {
            const input = document.querySelector('.chat-input');
            const message = input.value.trim();
            if (message) {
                addMessage(message, 'user');
                input.value = '';
                
                // Заглушка ответа AI
                setTimeout(() => {
                    addMessage('Спасибо за ваш ответ! Продолжайте работу над задачей.', 'ai');
                }, 500);
            }
        }
        
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = `message message-${sender}`;
            messageElement.textContent = text;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // Функция runTests() определена в interview.js
        
        function endInterview() {
            if (confirm('Завершить собеседование?')) {
                clearInterval(timerInterval);
                window.location.href = 'results';
            }
        }
    </script>
    <script src="/static/js/interview.js"></script>
</body>
</html>

